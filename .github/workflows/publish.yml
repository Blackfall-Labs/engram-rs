name: Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify tests pass
        run: cargo test --verbose

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --token ${CARGO_REGISTRY_TOKEN}

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: publish
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release Notes
        run: |
          echo "# engram-rs v${{ steps.get_version.outputs.VERSION }}" > release_notes.md
          echo "" >> release_notes.md
          echo "A unified Rust library for creating, reading, and managing Engram archives." >> release_notes.md
          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "\`\`\`toml" >> release_notes.md
          echo "[dependencies]" >> release_notes.md
          echo "engram-rs = \"${{ steps.get_version.outputs.VERSION }}\"" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Links" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **Crates.io**: https://crates.io/crates/engram-rs" >> release_notes.md
          echo "- **Documentation**: https://docs.rs/engram-rs/${{ steps.get_version.outputs.VERSION }}" >> release_notes.md
          echo "- **Repository**: https://github.com/blackfall-labs/engram-rs" >> release_notes.md
          echo "" >> release_notes.md
          if [ -f CHANGELOG.md ]; then
            echo "## Changelog" >> release_notes.md
            echo "" >> release_notes.md
            sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' >> release_notes.md || true
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
